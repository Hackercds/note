### Postman接口测试核心（pm语法详解）与JMeter压力测试进阶（脚本生成/场景设计）笔记

#### 一、Postman接口测试核心：pm语法与实战脚本
Postman的`pm`对象是接口测试的核心，用于获取响应、设置断言、处理变量等，以下是高频使用的语法和场景：

##### 1. 响应处理与断言（Tests标签页）
```javascript
// 1. 检查响应状态码（最基础断言）
pm.test("状态码为200", function () {
    pm.response.to.have.status(200);
    // 也可检查状态码文本，如pm.response.to.have.status("OK");
});

// 2. 检查响应时间（性能预判断）
pm.test("响应时间小于500ms", function () {
    pm.expect(pm.response.responseTime).to.be.below(500);
});

// 3. 解析JSON响应并断言字段
const jsonData = pm.response.json(); // 将响应转为JSON对象
pm.test("用户ID正确", function () {
    pm.expect(jsonData.userId).to.eql(123); // 精确匹配
    pm.expect(jsonData.name).to.include("张三"); // 包含字符串
    pm.expect(jsonData.age).to.be.greaterThan(18); // 数值比较
});

// 4. 检查响应头
pm.test("响应类型为JSON", function () {
    pm.response.to.have.header("Content-Type", "application/json");
});

// 5. 检查响应体包含指定字符串（非JSON场景）
pm.test("响应包含success", function () {
    pm.expect(pm.response.text()).to.include("success");
});
```

##### 2. 变量管理（环境变量/全局变量）
```javascript
// 1. 设置环境变量（仅当前环境生效）
const jsonData = pm.response.json();
pm.environment.set("token", jsonData.token); // 从响应中提取token存为环境变量
pm.environment.set("userId", 123); // 直接设置固定值

// 2. 设置全局变量（所有环境生效）
pm.globals.set("apiUrl", "https://api.example.com");

// 3. 获取变量并使用
const baseUrl = pm.environment.get("apiUrl");
pm.test("URL正确", function () {
    pm.expect(pm.request.url).to.include(baseUrl);
});

// 4. 清除变量
pm.environment.unset("token"); // 清除单个环境变量
pm.environment.clear(); // 清除当前环境所有变量
```

##### 3. 发送请求后关联（接口依赖处理）
例如：登录接口返回token，后续接口需要携带该token
```javascript
// 登录接口的Tests脚本：提取token并设置为环境变量
const jsonData = pm.response.json();
if (jsonData.token) {
    pm.environment.set("authToken", jsonData.token);
    pm.test("token提取成功", function () {
        pm.expect(jsonData.token).to.not.be.undefined;
    });
}

// 后续接口的Headers配置：引用变量
// 在请求头中添加：Authorization = Bearer {{authToken}}
```

##### 4. 动态参数生成（Pre-request Script标签页）
请求发送前生成随机数、时间戳等参数
```javascript
// 生成随机手机号
const phone = "138" + Math.floor(Math.random() * 100000000).toString().padStart(8, "0");
pm.environment.set("phone", phone);

// 生成当前时间戳（毫秒级）
const timestamp = new Date().getTime();
pm.environment.set("timestamp", timestamp);

// 生成UUID
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
pm.environment.set("uuid", generateUUID());
```


#### 二、JMeter压力测试进阶：脚本生成与场景设计
JMeter的核心是通过线程组、取样器、配置元件模拟真实用户行为，以下是实战细节：

##### 1. 快速生成接口测试脚本（从Postman导入）
- **步骤1**：Postman导出接口集合  
  选择集合 → 右键“Export” → 选择“Collection v2.1”格式保存为JSON文件。
- **步骤2**：JMeter导入脚本  
  打开JMeter → 右键“测试计划” → 添加“线程组” → 右键线程组 → “导入” → 选择Postman导出的JSON文件。  
  导入后会自动生成HTTP请求、Header等配置，只需补充变量和断言即可。

##### 2. 动态参数与关联（解决接口依赖）
例如：登录接口返回token，后续接口需要携带
- **步骤1**：提取token（添加“JSON Extractor”后置处理器）  
  右键登录请求 → 添加 → 后置处理器 → JSON Extractor  
  - 引用名称：`token`（后续引用时用`${token}`）  
  - JSON路径表达式：`$.data.token`（根据实际响应结构调整）  
  - 匹配数字：`0`（取第一个匹配值）
- **步骤2**：后续接口引用token  
  在HTTP请求的“Headers”中添加：`Authorization = Bearer ${token}`

##### 3. 生成自测脚本（模拟多用户随机数据）
- **方式1：用户定义的变量（固定参数）**  
  右键线程组 → 添加 → 配置元件 → 用户定义的变量  
  设置`baseUrl = https://api.example.com`，请求中用`${baseUrl}/user`引用。

- **方式2：CSV Data Set Config（批量数据）**  
  适用于多用户登录（不同账号密码）：  
  1. 准备CSV文件（users.csv）：  
     ```
     username,password
     user1,123456
     user2,abcdef
     ```
  2. 右键线程组 → 添加 → 配置元件 → CSV Data Set Config  
     - 文件名：`users.csv`  
     - 变量名称：`username,password`（与CSV表头一致）  
  3. 在登录请求的参数中引用：`${username}`、`${password}`

- **方式3：随机函数（动态生成）**  
  在请求参数中直接使用JMeter内置函数：  
  - 随机数字：`${__Random(1000,9999)}`（生成1000-9999的随机数）  
  - 随机字符串：`${__RandomString(8,abcdefghijklmnopqrstuvwxyz)}`（生成8位随机小写字母）  
  - 当前时间：`${__time(yyyyMMddHHmmss)}`（生成时间戳）

##### 4. 压力测试场景设计（线程组配置）
- **基础线程组参数**：  
  - 线程数：并发用户数（如100表示100个用户同时请求）  
  - Ramp-Up时间：启动所有线程的耗时（如10秒启动100个线程，即每秒启动10个）  
  - 循环次数：每个线程发送请求的次数（勾选“永远”可持续压测，手动停止）

- **高级场景：阶梯加压（用“阶梯线程组”插件）**  
  1. 安装插件：JMeter插件管理器 → 搜索“Stepping Thread Group”并安装  
  2. 配置阶梯：  
     - 初始线程数：0  
     - 启动线程数：50，每30秒启动一次  
     - 持续时间：60秒（每个阶梯运行60秒）  
     - 总线程数：200（最终达到200并发）  
  作用：模拟用户数逐渐增加的场景，观察系统何时出现性能拐点。

##### 5. 结果分析关键指标（监听器配置）
- **聚合报告**：必看指标  
  - 样本数：总请求数  
  - 平均值：平均响应时间（ms）  
  - 90% Line：90%的请求响应时间不超过该值（比平均值更能反映用户体验）  
  - 吞吐量（Throughput）：每秒处理的请求数（TPS），越高越好  
  - 错误率：失败请求占比（需控制在0.1%以内）

- **响应时间曲线图**：观察响应时间随并发数的变化趋势，判断何时出现延迟突增。

- **TPS曲线图**：观察吞吐量是否随并发增加而线性增长，若增长停滞或下降，说明达到系统瓶颈。


#### 三、实战技巧总结
1. **Postman批量执行接口**  
   选择集合 → 点击“Runner” → 勾选需要执行的接口 → 设置迭代次数（如10次） → 运行后查看通过率和响应时间，适合回归测试。

2. **JMeter避免压测机成为瓶颈**  
   - 非GUI模式运行：`jmeter -n -t test.jmx -l result.jtl`（比GUI模式节省资源）  
   - 限制单台压测机线程数：若并发超过1000，建议用分布式压测（多台机器同时施压）。

3. **接口测试与压力测试联动**  
   - 先用Postman完成单接口功能验证和参数校验（确保接口正确）  
   - 再用JMeter导入脚本，扩展为多线程压力测试（验证性能）。

这些细节覆盖了日常接口测试和压力测试的核心场景，重点掌握`pm`语法的断言和变量提取，以及JMeter的参数关联和场景设计，足以应对大部分企业级测试需求。